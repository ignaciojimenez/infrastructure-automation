#!/bin/bash
# Home Assistant Update Script

set -euo pipefail

CONTAINER_NAME="home-assistant"
IMAGE_NAME="ghcr.io/home-assistant/home-assistant:stable"
BACKUP_DIR="$HOME/homeassistant/backups"
LOG_FILE="$HOME/logs/ha_update.log"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Function to create backup
create_backup() {
    log_message "Creating backup before update..."
    mkdir -p "$BACKUP_DIR"
    
    local backup_file="$BACKUP_DIR/ha_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    
    if tar -czf "$backup_file" -C "$HOME/homeassistant" --exclude="backups" .; then
        log_message "âœ… Backup created: $backup_file"
        
        # Keep only last 5 backups
        cd "$BACKUP_DIR"
        ls -t ha_backup_*.tar.gz | tail -n +6 | xargs rm -f 2>/dev/null || true
        
        return 0
    else
        log_message "âŒ Failed to create backup"
        return 1
    fi
}

# Function to update Home Assistant
update_ha() {
    log_message "ğŸ”„ Starting Home Assistant update..."
    
    # Create backup first
    if ! create_backup; then
        log_message "âŒ Update aborted due to backup failure"
        exit 1
    fi
    
    # Pull latest image
    log_message "ğŸ“¥ Pulling latest Home Assistant image..."
    if docker pull "$IMAGE_NAME"; then
        log_message "âœ… Latest image pulled successfully"
    else
        log_message "âŒ Failed to pull latest image"
        exit 1
    fi
    
    # Stop current container
    log_message "ğŸ›‘ Stopping current Home Assistant container..."
    if docker stop "$CONTAINER_NAME" 2>/dev/null; then
        log_message "âœ… Container stopped"
    else
        log_message "âš ï¸  Container was not running"
    fi
    
    # Remove old container
    log_message "ğŸ—‘ï¸  Removing old container..."
    if docker rm "$CONTAINER_NAME" 2>/dev/null; then
        log_message "âœ… Old container removed"
    else
        log_message "âš ï¸  No container to remove"
    fi
    
    # Start new container
    log_message "ğŸš€ Starting updated Home Assistant container..."
    if docker run -d \
        --name "$CONTAINER_NAME" \
        --restart=unless-stopped \
        --privileged \
        -v "$HOME/homeassistant:/config" \
        -v "/etc/localtime:/etc/localtime:ro" \
        --network=host \
        -e TZ="Europe/Madrid" \
        "$IMAGE_NAME"; then
        log_message "âœ… New container started successfully"
    else
        log_message "âŒ Failed to start new container"
        exit 1
    fi
    
    # Wait for Home Assistant to be ready
    log_message "â³ Waiting for Home Assistant to be ready..."
    local timeout=300
    local count=0
    
    while [ $count -lt $timeout ]; do
        if curl -s http://localhost:8123 >/dev/null 2>&1; then
            log_message "âœ… Home Assistant is ready!"
            break
        fi
        
        sleep 2
        count=$((count + 2))
    done
    
    if [ $count -ge $timeout ]; then
        log_message "âš ï¸  Home Assistant may not be fully ready yet"
    fi
    
    # Clean up old images
    log_message "ğŸ§¹ Cleaning up old Docker images..."
    docker image prune -f >/dev/null 2>&1 || true
    
    log_message "ğŸ‰ Home Assistant update completed successfully!"
}

# Main execution
main() {
    log_message "ğŸ  Home Assistant Update Script Started"
    
    # Check if Docker is running
    if ! docker info >/dev/null 2>&1; then
        log_message "âŒ Docker is not running"
        exit 1
    fi
    
    update_ha
    
    log_message "âœ… Update process completed"
}

# Run main function
main "$@"
