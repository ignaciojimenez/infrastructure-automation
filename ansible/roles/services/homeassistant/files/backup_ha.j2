#!/bin/bash
# Home Assistant Backup Script

set -euo pipefail

CONTAINER_NAME="{{ container_name }}"
CONFIG_DIR="{{ homeassistant_config_dir }}"
BACKUP_DIR="$CONFIG_DIR/backups"
LOG_FILE="{{ logs_dir }}/ha_backup.log"

# Function to log messages
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Function to create backup
create_backup() {
    local backup_type="${1:-manual}"
    local backup_name="ha_${backup_type}_$(date +%Y%m%d_%H%M%S)"
    local backup_file="$BACKUP_DIR/${backup_name}.tar.gz"
    
    log_message "üì¶ Creating $backup_type backup: $backup_name"
    
    # Create backup directory
    mkdir -p "$BACKUP_DIR"
    
    # Create backup excluding the backups directory itself
    if tar -czf "$backup_file" -C "$CONFIG_DIR" --exclude="backups" --exclude="*.log" .; then
        local size=$(du -h "$backup_file" | cut -f1)
        log_message "‚úÖ Backup created successfully: $backup_file ($size)"
        
        # Clean up old backups based on type
        cleanup_old_backups "$backup_type"
        
        echo "$backup_file"
        return 0
    else
        log_message "‚ùå Failed to create backup"
        return 1
    fi
}

# Function to cleanup old backups
cleanup_old_backups() {
    local backup_type="$1"
    local keep_count
    
    case "$backup_type" in
        "manual")
            keep_count=10
            ;;
        "auto")
            keep_count=7
            ;;
        *)
            keep_count=5
            ;;
    esac
    
    log_message "üßπ Cleaning up old $backup_type backups (keeping $keep_count)"
    
    cd "$BACKUP_DIR"
    ls -t ha_${backup_type}_*.tar.gz 2>/dev/null | tail -n +$((keep_count + 1)) | xargs rm -f 2>/dev/null || true
}

# Function to list backups
list_backups() {
    log_message "üìã Available backups:"
    
    if [ -d "$BACKUP_DIR" ] && [ "$(ls -A "$BACKUP_DIR"/*.tar.gz 2>/dev/null)" ]; then
        cd "$BACKUP_DIR"
        ls -lht *.tar.gz | while read -r line; do
            echo "  $line"
        done
    else
        echo "  No backups found"
    fi
}

# Function to restore backup
restore_backup() {
    local backup_file="$1"
    
    if [ ! -f "$backup_file" ]; then
        log_message "‚ùå Backup file not found: $backup_file"
        return 1
    fi
    
    log_message "‚ö†Ô∏è  WARNING: This will overwrite current Home Assistant configuration!"
    read -p "Are you sure you want to restore from $backup_file? (yes/no): " confirm
    
    if [ "$confirm" != "yes" ]; then
        log_message "‚ùå Restore cancelled"
        return 1
    fi
    
    # Stop Home Assistant if running
    if docker ps -q -f name="$CONTAINER_NAME" | grep -q .; then
        log_message "üõë Stopping Home Assistant for restore..."
        docker stop "$CONTAINER_NAME"
    fi
    
    # Create backup of current state before restore
    log_message "üì¶ Creating backup of current state before restore..."
    create_backup "pre_restore" >/dev/null
    
    # Restore from backup
    log_message "üîÑ Restoring from backup..."
    
    # Create temporary directory for extraction
    local temp_dir=$(mktemp -d)
    
    if tar -xzf "$backup_file" -C "$temp_dir"; then
        # Remove current config (except backups)
        find "$CONFIG_DIR" -mindepth 1 -maxdepth 1 ! -name "backups" -exec rm -rf {} +
        
        # Copy restored files
        cp -r "$temp_dir"/* "$CONFIG_DIR"/
        
        # Clean up temp directory
        rm -rf "$temp_dir"
        
        log_message "‚úÖ Restore completed successfully"
        
        # Start Home Assistant
        log_message "üöÄ Starting Home Assistant..."
        if docker start "$CONTAINER_NAME" 2>/dev/null; then
            log_message "‚úÖ Home Assistant started"
        else
            log_message "‚ö†Ô∏è  Please start Home Assistant manually"
        fi
        
        return 0
    else
        log_message "‚ùå Failed to restore from backup"
        rm -rf "$temp_dir"
        return 1
    fi
}

# Function to show usage
show_usage() {
    echo "Usage: $0 {create|list|restore} [options]"
    echo ""
    echo "Commands:"
    echo "  create [manual|auto]  - Create backup (default: manual)"
    echo "  list                  - List available backups"
    echo "  restore <backup_file> - Restore from backup file"
    echo ""
    echo "Examples:"
    echo "  $0 create"
    echo "  $0 create auto"
    echo "  $0 list"
    echo "  $0 restore $BACKUP_DIR/ha_manual_20240101_120000.tar.gz"
    exit 1
}

# Main execution
main() {
    case "${1:-}" in
        "create")
            local backup_type="${2:-manual}"
            create_backup "$backup_type"
            ;;
        "list")
            list_backups
            ;;
        "restore")
            if [ -z "${2:-}" ]; then
                echo "‚ùå Please specify backup file to restore"
                show_usage
            fi
            restore_backup "$2"
            ;;
        *)
            show_usage
            ;;
    esac
}

# Run main function
main "$@"
