# Home Assistant Automations - Managed by Ansible

# Sunset lights
- id: '1614473127522'
  alias: Sunset lights on - sun elevation
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      value_template: '{{ "{{ state_attr(\"sun.sun\", \"elevation\") }}" }}'
      below: '1.5'
  condition:
    - condition: state
      entity_id: group.persons
      state: home
  action:
    - service: scene.turn_on
      target:
        entity_id: scene.chill
  mode: single

# Lights off automations
- id: '1638915083194'
  alias: lights off - week
  trigger:
    - platform: time
      at: '00:30:00'
  condition:
    - condition: time
      weekday: [mon, tue, wed, thu, fri]
  action:
    - service: light.turn_off
      target:
        entity_id: light.living_room_lights
  mode: single

- id: '1638916130644'
  alias: lights off - weekend
  trigger:
    - platform: time
      at: '02:30:00'
  condition:
    - condition: time
      weekday: [sat, sun]
  action:
    - service: light.turn_off
      target:
        entity_id: light.living_room_lights
  mode: single

# Daily backups
- id: '1687725012156'
  alias: Daily backups
  trigger:
    - platform: time
      at: '03:00:00'
  action:
    - service: backup.create
  mode: single

 # Away/Home mode
# Uses template trigger to treat both "not_home" and "unknown" as away,
# preventing hourly device-tracker polling blips from resetting the timer.
# Uses hvac_mode off/heat instead of preset_mode since HomeKit Controller
# climates don't support Tado preset modes.
- id: "away_mode_everyone_left"
  alias: "Away Mode - Everyone Left"
  trigger:
    - platform: template
      value_template: >
        {{ '{{ states("group.persons") != "home" }}' }}
      for:
        minutes: 6
  condition:
    - condition: state
      entity_id: input_boolean.guest_mode
      state: "off"
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id: group.homekit_tado_climates
      data:
        hvac_mode: "off"
    - service: light.turn_off
      target:
        entity_id: light.all_lights
    - service: rest_command.slack_alert
      data:
        message: "Away mode activated â€” heating off"
  mode: single

- id: "home_mode_first_arrives"
  alias: "Home Mode - First Person Arrives"
  trigger:
    - platform: state
      entity_id: group.persons
      to: "home"
  condition:
    - condition: template
      value_template: >
        {{ '{{ states("climate.tado_smart_thermostat_ru3393984256") == "off" }}' }}
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id: group.homekit_tado_climates
      data:
        hvac_mode: "heat"
    - service: rest_command.slack_notify
      data:
        message: "Welcome home! Heating restored."
  mode: single

# Guest mode
- id: "guest_mode_enabled"
  alias: "Guest Mode - Disable Auto Away"
  trigger:
    - platform: state
      entity_id: input_boolean.guest_mode
      to: "on"
  action:
    - service: automation.turn_off
      target:
        entity_id: automation.away_mode_everyone_left
  mode: single

- id: "guest_mode_disabled"
  alias: "Guest Mode Off - Enable Auto Away"
  trigger:
    - platform: state
      entity_id: input_boolean.guest_mode
      to: "off"
  action:
    - service: automation.turn_on
      target:
        entity_id: automation.away_mode_everyone_left
  mode: single

# Wyze bulb monitoring - alerts when specific bulbs go offline/online
- id: "wyze_bulb_offline_alert"
  alias: "Wyze Bulb Offline Alert"
  trigger:
    - platform: state
      entity_id:
        - light.floor_lamp
        - light.floor_lamp_new
        - light.book_floor_lamp
        - light.table_lamp
      to: "unavailable"
      for:
        minutes: 5
  action:
    - service: rest_command.slack_notify
      data:
        message: "{{ '{{' }} \"âš ï¸ Wyze bulb offline: \" ~ (trigger.to_state.attributes.friendly_name | default(trigger.entity_id)) {{ '}}' }}"
  mode: parallel

- id: "wyze_bulb_online_recovery"
  alias: "Wyze Bulb Online Recovery"
  trigger:
    - platform: state
      entity_id:
        - light.floor_lamp
        - light.floor_lamp_new
        - light.book_floor_lamp
        - light.table_lamp
      from: "unavailable"
  action:
    - service: rest_command.slack_notify
      data:
        message: "{{ '{{' }} \"âœ… Wyze bulb back online: \" ~ (trigger.to_state.attributes.friendly_name | default(trigger.entity_id)) {{ '}}' }}"
  mode: parallel

# HomeKit heating availability monitoring
- id: "homekit_tado_climate_offline_alert"
  alias: "HomeKit Tado Climate Offline Alert"
  trigger:
    - platform: state
      entity_id:
        - climate.tado_smart_thermostat_ru3393984256
        - climate.tado_smart_thermostat_su3182126080
        - climate.tado_smart_radiator_thermostat_va3363583744
        - climate.tado_smart_radiator_thermostat_va0290656256
        - climate.tado_smart_radiator_thermostat_va2220036096
        - climate.tado_smart_radiator_thermostat_va0612513536
        - climate.tado_smart_radiator_thermostat_va1065432832
        - climate.tado_smart_radiator_thermostat_va2323724032
      to: "unavailable"
      for:
        minutes: 10
  action:
    - service: rest_command.slack_alert
      data:
        message: "{{ '{{' }} \"âš ï¸ Heating offline: \" ~ (trigger.to_state.attributes.friendly_name | default(trigger.entity_id)) {{ '}}' }}"
  mode: parallel

- id: "homekit_tado_climate_online_recovery"
  alias: "HomeKit Tado Climate Online Recovery"
  trigger:
    - platform: state
      entity_id:
        - climate.tado_smart_thermostat_ru3393984256
        - climate.tado_smart_thermostat_su3182126080
        - climate.tado_smart_radiator_thermostat_va3363583744
        - climate.tado_smart_radiator_thermostat_va0290656256
        - climate.tado_smart_radiator_thermostat_va2220036096
        - climate.tado_smart_radiator_thermostat_va0612513536
        - climate.tado_smart_radiator_thermostat_va1065432832
        - climate.tado_smart_radiator_thermostat_va2323724032
      from: "unavailable"
  action:
    - service: rest_command.slack_notify
      data:
        message: "{{ '{{' }} \"âœ… Heating back online: \" ~ (trigger.to_state.attributes.friendly_name | default(trigger.entity_id)) {{ '}}' }}"
  mode: parallel

# Eve door sensors - notification when doors open while nobody is home
# Only triggers if group.persons has been not_home for at least 5 minutes
# (avoids false alerts when leaving home and crossing geofence)
# Sensor mapping:
#   binary_sensor.eve_door_20ebn9901_door   -> Balcony Door
#   binary_sensor.eve_door_20ebn9901_door_2 -> Entrance Door
- id: "eve_door_open_while_away"
  alias: "Door Opened While Away"
  trigger:
    - platform: state
      entity_id: binary_sensor.eve_door_20ebn9901_door
      to: "on"
      id: balcony
    - platform: state
      entity_id: binary_sensor.eve_door_20ebn9901_door_2
      to: "on"
      id: entrance
  condition:
    - condition: state
      entity_id: group.persons
      state: "not_home"
      for:
        minutes: 5
  action:
    - service: rest_command.slack_alert
      data:
        message: "{{ '{{' }} \"ðŸšª Balcony\" if trigger.id == \"balcony\" else \"ðŸšª Entrance\" {{ '}}' }} door opened while away"
  mode: single

# ============================================================
# TRAIN COMMUTE NOTIFICATION
# ============================================================
# Sends train platform info when Choco leaves home on weekday mornings

- id: "train_commute_notification"
  alias: "Train Commute - Platform Notification"
  description: "Send NS train platform info when leaving for work (combined Tado + Companion app)"
  trigger:
    - platform: state
      entity_id: binary_sensor.choco_presence
      from: "on"
      to: "off"
  condition:
    - condition: time
      after: "07:00:00"
      before: "10:00:00"
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
    - condition: state
      entity_id: input_boolean.train_notified_today
      state: "off"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.train_notified_today
    - service: shell_command.notify_train_platform
  mode: single

- id: "train_notification_reset"
  alias: "Train Notification - Daily Reset"
  description: "Reset train notification flag at midnight"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.train_notified_today
  mode: single

# ============================================================
# SECURITY MONITORING
# ============================================================
- id: 'security_login_failure_alert'
  alias: 'Security: Failed Login Attempts Alert'
  description: 'Alert on failed login attempts and IP bans via Slack'
  trigger:
    - platform: persistent_notification
      update_type: added
  condition:
    - condition: template
      value_template: >
        {{ '{% set message = trigger.notification.message | default("") %}' }}
        {{ '{% set title = trigger.notification.title | default("") %}' }}
        {{ '{{ "Login attempt" in message or "login attempt" in message or' }}
           {{ '"Too many login attempts" in message or "Banned" in message or' }}
           {{ '"invalid authentication" in message }}' }}
  action:
    - service: rest_command.slack_alert
      data:
        message: >
          {{ 'ðŸš¨ Security Alert - {{ now().strftime("%Y-%m-%d %H:%M:%S") }}' }}
          
          {{ '{% set msg = trigger.notification.message | default("") %}' }}
          {{ '{% set title = trigger.notification.title | default("") %}' }}
          {{ '{% if "Too many login attempts" in msg or "Banned" in msg %}' }}
          {{ '*IP BANNED*' }}
          {{ '{% elif "invalid authentication" in msg or "login attempt" in msg %}' }}
          {{ '*Failed Login Attempt*' }}
          {{ '{% else %}' }}
          {{ '*Security Event*' }}
          {{ '{% endif %}' }}
          
          {{ '{{ title }}' }}
          {{ '{{ msg }}' }}
  mode: queued
  max: 10
