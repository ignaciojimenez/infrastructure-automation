# Home Assistant Configuration
# Managed by Ansible - Manual changes will be overwritten

# Core configuration
homeassistant:
  external_url: "https://ha.ignacio.systems"
  internal_url: "http://localhost:8123"

# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

# Text-to-speech
tts:
  - platform: google_translate

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

#### Manual configs from this point
group: !include groups.yaml

# Light Groups
light:
  - platform: group
    name: All lights
    entities:
{% for light in homeassistant_lights | default(['light.floor_lamp', 'light.book_floor_lamp', 'light.table_lamp', 'light.floor_lamp_new', 'light.shelly_luz_outdoor', 'light.shelly_luz_salon']) %}
      - {{ light }}
{% endfor %}
  - platform: group
    name: Living room lights
    entities:
{% for light in homeassistant_living_room_lights | default(['light.floor_lamp', 'light.book_floor_lamp', 'light.table_lamp', 'light.floor_lamp_new', 'light.shelly_luz_outdoor', 'light.shelly_luz_salon']) %}
      - {{ light }}
{% endfor %}

# Logger configuration
logger:
  default: warning
  logs:
    custom_components.wyzeapi: debug

# Input Booleans
input_boolean:
  guest_mode:
    name: Guest Mode
    icon: mdi:account-multiple
  train_notified_today:
    name: Train Notification Sent Today
    icon: mdi:train

# Template sensors (modern syntax)
template:
  - binary_sensor:
      - name: "Wyze Online"
        unique_id: wyze_online
        device_class: connectivity
        state: >
          {{ '{{ states(\'light.floor_lamp_new\') not in [\'unavailable\', \'unknown\'] }}' }}
      # Presence detection
      - name: "Home Occupied"
        unique_id: home_occupied
        device_class: occupancy
        state: >
          {{ '{{ is_state("group.persons", "home") }}' }}
        icon: >
          {{ '{% if is_state("group.persons", "home") %}' }}
            mdi:home-account
          {{ '{% else %}' }}
            mdi:home-outline
          {{ '{% endif %}' }}
      
      # Choco presence (Companion App device tracker)
      - name: "Choco Presence"
        unique_id: choco_presence_combined
        device_class: presence
        state: '{{ "{{ is_state(\"device_tracker.nexuschoky\", \"home\") }}" }}'

      # Candela presence (Companion App device tracker)
      - name: "Candela Presence"
        unique_id: candela_presence_combined
        device_class: presence
        state: '{{ "{{ is_state(\"device_tracker.iphone_de_candela_2\", \"home\") }}" }}'

# Slack notifications (webhooks stored in secrets.yaml)
rest_command:
  slack_notify:
    url: !secret slack_log_webhook
    method: post
    headers:
      Content-Type: application/json
    payload: >
      {
        "text": "{{ '{{ message }}' }}"
      }
  slack_alert:
    url: !secret slack_alert_webhook
    method: post
    headers:
      Content-Type: application/json
    payload: >
      {
        "text": "{{ '{{ message }}' }}"
      }

# HTTP configuration for reverse proxy (Cloudflare Tunnel)
http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1
    - ::1
  ip_ban_enabled: true
  login_attempts_threshold: 5

# Shell commands
shell_command:
  notify_train_platform: '/config/scripts/notify_train_platform.sh'
  tado_set_away: '/config/scripts/tado_presence.sh AWAY'
  tado_set_home: '/config/scripts/tado_presence.sh HOME'
