---
# Deploy monitoring scripts to all hosts
# Includes common scripts and platform-specific monitoring
# Usage: ansible-playbook ansible/playbooks/deploy_monitoring.yml

- name: Deploy common monitoring scripts
  hosts: all
  become: true
  tasks:
    - name: Ensure base scripts directory exists
      ansible.builtin.file:
        path: "{{ scripts_dir }}"
        state: directory
        owner: "{{ infrastructure_user }}"
        group: "{{ infrastructure_group }}"
        mode: '0755'
      tags: [monitoring, scripts]
    
    - name: Find all scripts in common directory
      ansible.builtin.find:
        paths: "{{ playbook_dir }}/../../scripts/common/"
        file_type: file
      register: common_scripts
      delegate_to: localhost
      become: false  # Don't sudo on control machine
      run_once: true
      tags: [monitoring, scripts]
    
    - name: Deploy all common scripts
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "{{ scripts_dir }}/{{ item.path | basename }}"
        mode: '0755'
        owner: "{{ infrastructure_user }}"
        group: "{{ infrastructure_group }}"
      loop: "{{ common_scripts.files }}"
      tags: [monitoring, scripts]
      
    - name: Restart monitoring services if needed
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - cron
      when: ansible_service_mgr == "systemd"
      failed_when: false
      tags: [monitoring, services]
      
    - name: Report common scripts deployment complete
      ansible.builtin.debug:
        msg: "âœ… Common monitoring scripts deployed to {{ inventory_hostname }}"

# Deploy platform-specific monitoring
- name: Deploy Proxmox monitoring
  hosts: proxmox_hosts
  become: true
  roles:
    - role: platform/proxmox
  tags: [monitoring, proxmox]

- name: Deploy OPNsense monitoring
  hosts: freebsd_hosts
  become: true
  roles:
    - role: platform/opnsense
  tags: [monitoring, opnsense]
