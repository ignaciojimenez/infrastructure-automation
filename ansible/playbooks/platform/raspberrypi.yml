---
# Raspberry Pi-specific configuration

- name: Configure Raspberry Pi specific settings
  hosts: raspberrypi
  become: true
  handlers:
    - name: reboot_required
      ansible.builtin.debug:
        msg: "Reboot required - will be handled at end of playbook"
      listen: "reboot_required"
  tasks:
    - name: Raspberry Pi memory optimizations
      ansible.builtin.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-raspberry-pi.conf
      loop:
        - { name: 'vm.swappiness', value: '10' }
        - { name: 'vm.vfs_cache_pressure', value: '50' }
      when: platform_type == "raspberrypi"
      tags: [raspberrypi, optimization]
      
    - name: Disable Bluetooth overlay on Raspberry Pi
      ansible.builtin.lineinfile:
        path: /boot/config.txt
        line: "dtoverlay=disable-bt"
        state: present
        create: false
      when:
        - platform_type == "raspberrypi"
        - disable_bluetooth | default(true)
      tags: [raspberrypi, optimization, bluetooth]
    
    - name: Disable Bluetooth services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: false
        state: stopped
      loop:
        - hciuart.service
        - bluetooth.service
      ignore_errors: true
      when:
        - platform_type == "raspberrypi"
        - disable_bluetooth | default(true)
      tags: [raspberrypi, optimization, bluetooth]
      # Note: hciuart.service only exists on very old Pi/Raspbian versions
      # Modern systems won't have it - that's expected and OK
      
    - name: Create systemd service to disable HDMI on boot
      ansible.builtin.copy:
        content: |
          [Unit]
          Description=Disable HDMI to save power
          After=multi-user.target
          
          [Service]
          Type=oneshot
          ExecStart=/usr/bin/tvservice -o
          RemainAfterExit=yes
          
          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/disable-hdmi.service
        owner: root
        group: root
        mode: '0644'
      when:
        - platform_type == "raspberrypi"
        - disable_hdmi | default(true)
      notify: reboot_required
      tags: [raspberrypi, optimization, hdmi]
    
    - name: Enable HDMI disable service
      ansible.builtin.systemd:
        name: disable-hdmi
        enabled: true
        daemon_reload: true
      when:
        - platform_type == "raspberrypi"
        - disable_hdmi | default(true)
      tags: [raspberrypi, optimization, hdmi]
