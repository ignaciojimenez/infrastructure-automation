// Unattended-Upgrade configuration - Migrated from raspberrypi-ansible
// Generated by Ansible - {{ ansible_date_time.iso8601 }}
// Based on https://gist.github.com/anatolebeuzon/98ff195f3375e8ca621e7df3955b4f23

Unattended-Upgrade::Origins-Pattern {
        // SECURITY UPDATES ONLY - No regular feature updates
        
        // Debian security updates
        "origin=Debian,codename=${distro_codename},label=Debian-Security";
        "origin=Debian,codename=${distro_codename}-security,label=Debian-Security";
        
        // For systems running oldstable
        "origin=Debian,codename=oldstable,label=Debian-Security";
        "origin=Debian,codename=oldstable-security,label=Debian-Security";
        
        // Raspbian security updates
        "origin=Raspbian,codename=${distro_codename},label=Raspbian-Security";
        "origin=Raspberry Pi Foundation,codename=${distro_codename},label=Raspberry Pi Foundation-Security";
};

// Package blacklist: packages that should *never* be automatically upgraded
Unattended-Upgrade::Package-Blacklist {
        // Docker packages - critical for Home Assistant, update manually
        "docker-ce";
        "docker-ce-cli";
        "docker-ce-rootless-extras";
        "docker-compose-plugin";
        "docker-buildx-plugin";
        "containerd.io";
{% if custom_blacklist is defined %}
{% for package in custom_blacklist %}
        "{{ package }}";
{% endfor %}
{% endif %}
};

// Email notifications (optional)
{% if notification_email is defined %}
Unattended-Upgrade::Mail "{{ notification_email }}";
Unattended-Upgrade::MailReport "only-on-error";
{% else %}
//Unattended-Upgrade::Mail "";
{% endif %}

// Remove unused dependencies from the upgrade process
Unattended-Upgrade::Remove-Unused-Dependencies "true";

// Remove unused kernel packages
Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";

// Automatically reboot *WITHOUT CONFIRMATION* if
//  the file /var/run/reboot-required is found after the upgrade
Unattended-Upgrade::Automatic-Reboot "{{ auto_reboot | default(true) }}";

// If automatic reboot is enabled and needed, reboot at the specific
// time instead of immediately
//  Default: "now"
Unattended-Upgrade::Automatic-Reboot-Time "{{ auto_reboot_time | default('04:00') }}";
Unattended-Upgrade::Automatic-Reboot-WithUsers "false";

// Logging
Unattended-Upgrade::SyslogEnable "true";
Unattended-Upgrade::SyslogFacility "daemon";

// Download and install upgrades in minimal steps
Unattended-Upgrade::MinimalSteps "true";

// Bandwidth limits (in kb/s, 0 = unlimited)
{% if bandwidth_limit is defined %}
Acquire::http::Dl-Limit "{{ bandwidth_limit }}";
{% else %}
//Acquire::http::Dl-Limit "0";
{% endif %}
